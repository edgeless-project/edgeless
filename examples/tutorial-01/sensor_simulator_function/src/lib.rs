use edgeless_function::api::*;
use log;

struct SensorSimulatorFunction;

const RANDOM_VALUES: [&'static f32; 100] = [
    &94.84184092384368,
    &-45.43097667897547,
    &68.47551564621293,
    &-5.061908023036011,
    &95.93435118725435,
    &80.08148572212568,
    &52.485597653639104,
    &-72.63084671950784,
    &22.046618549615488,
    &19.04797889080743,
    &38.00124369751984,
    &34.43619583994641,
    &14.900240617461819,
    &-16.465653712084233,
    &21.78026999710147,
    &46.990029503840844,
    &-63.05234252839185,
    &73.99720578089472,
    &-93.57510243228195,
    &-87.11068068114314,
    &99.99514904308359,
    &-35.46603029448032,
    &12.311008219434399,
    &82.82755427791395,
    &-67.305995356857,
    &89.4588953359303,
    &23.572344440694977,
    &51.19212245125786,
    &-93.90152658144144,
    &23.230550044784465,
    &-69.31604930820639,
    &4.255592066129822,
    &76.79928431034003,
    &-57.81350903171256,
    &-46.576903999773236,
    &68.2408458181493,
    &-52.53077015681376,
    &77.74057436505501,
    &-40.6784188877739,
    &-66.67412559661996,
    &-84.69734533034745,
    &-41.138816529913626,
    &-35.12131962532261,
    &-55.359455201149665,
    &50.157235286858054,
    &16.45536738003716,
    &39.8177679192099,
    &42.77308916423067,
    &-93.53807991622492,
    &-14.385103539189132,
    &28.336326438959702,
    &-74.95675320811613,
    &47.35356580422203,
    &6.537977383483778,
    &-33.85525146472909,
    &5.504574240026102,
    &93.01591663851539,
    &-64.41926490955157,
    &-63.9134742124307,
    &26.592915358216572,
    &-25.47379470805069,
    &80.52080114755884,
    &-29.19023968971581,
    &26.849064605413233,
    &-92.03757175605341,
    &11.781783205761798,
    &85.06957810185529,
    &-40.860109056241754,
    &-16.56383086788844,
    &-86.96362026045608,
    &72.15268546266239,
    &-42.61952643074531,
    &-37.69315472280106,
    &81.300586636301,
    &-69.67294908600728,
    &-44.877871642935595,
    &-97.46241339650308,
    &27.72748685065605,
    &-63.40097365276045,
    &-86.34421278429447,
    &-31.540737208166945,
    &-67.32231045415942,
    &67.53952842540684,
    &-89.28456289437139,
    &-18.95252738466131,
    &-64.81193542673051,
    &71.3922776826389,
    &-70.0803029116448,
    &56.61731984517374,
    &-27.026191589492754,
    &-56.93539603685422,
    &-41.62888437513323,
    &44.96735921603948,
    &-99.12236866086512,
    &96.04710395138392,
    &49.569659950219545,
    &1.4678654223873764,
    &38.98032943149923,
    &-72.82698188600693,
    &-5.880393484541017,
];

impl Edgefunction for SensorSimulatorFunction {
    fn handle_cast(src: InstanceId, encoded_message: String) {
        if let Ok(mut index) = encoded_message.parse::<usize>() {
            if index >= RANDOM_VALUES.len() {
                index = 0;
            }
            let value = RANDOM_VALUES[index];
            index += 1;
            log::info!("sensor_simulator {}:{}, new value generated: {}", src.node, src.function, value);
            cast_alias(&"output", format!("{}", value).as_str());
            delayed_cast(100, &slf(), format!("{}", index).as_str());
        }
    }

    fn handle_call(_src: InstanceId, _encoded_message: String) -> CallRet {
        CallRet::Noreply
    }

    fn handle_init(_payload: String, _serialized_state: Option<String>) {
        edgeless_function::init_logger();
        cast(&slf(), &"0");
    }

    fn handle_stop() {
        // noop
    }
}

edgeless_function::export!(SensorSimulatorFunction);
